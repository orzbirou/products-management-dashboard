<div class="products-container">
  <h2>Products List</h2>

  <div class="filters-toolbar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search</mat-label>
      <input
        matInput
        [formControl]="searchControl"
        placeholder="Search by name/description"
      />
    </mat-form-field>

    <mat-form-field appearance="outline" class="status-field">
      <mat-label>Status</mat-label>
      <mat-select [formControl]="statusControl">
        <mat-option value="all">All</mat-option>
        <mat-option value="active">Active</mat-option>
        <mat-option value="inactive">Inactive</mat-option>
        <mat-option value="draft">Draft</mat-option>
      </mat-select>
    </mat-form-field>

    <button
      mat-raised-button
      color="primary"
      (click)="goToCreate()"
      class="new-product-btn"
    >
      Add New Product
    </button>
  </div>

  <!-- Loading state -->
  @if (loading$ | async) {
  <div class="loading-container">
    <p>Loading products...</p>
  </div>
  } @else {
  <!-- Error state -->
  @if (error$ | async; as error) {
  <div class="error-container">
    <p class="error-message">{{ error }}</p>
  </div>
  } @else {
  <!-- Data / Empty state (subscribe once) -->
  @if (view$ | async; as view) { @if (view.items.length === 0) {
  <div class="no-data-container">
    <p>No products found.</p>
  </div>
  } @else {
  <!-- Desktop Table View -->
  <div class="desktop-view">
    <table
      mat-table
      [dataSource]="view.items"
      class="products-table"
      matSort
      (matSortChange)="onSortChange($event)"
    >
      <!-- ID Column -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let product">{{ product.id }}</td>
      </ng-container>

      <!-- Image Column -->
      <ng-container matColumnDef="imgUrl">
        <th mat-header-cell *matHeaderCellDef>Image</th>
        <td mat-cell *matCellDef="let product">
          @if (product.imgUrl) {
          <img
            [src]="product.imgUrl"
            [alt]="product.name"
            class="product-image"
          />
          } @else {
          <span class="no-image">No image</span>
          }
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="name">Name</th>
        <td mat-cell *matCellDef="let product">{{ product.name }}</td>
      </ng-container>

      <!-- Description Column -->
      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef>Description</th>
        <td mat-cell *matCellDef="let product">
          {{ product.description || "N/A" }}
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="price">Price</th>
        <td mat-cell *matCellDef="let product">
          ${{ product.price | number : "1.2-2" }}
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let product">
          <span [class]="'status-' + product.status">
            {{ product.status | titlecase }}
          </span>
        </td>
      </ng-container>

      <!-- Created At Column -->
      <ng-container matColumnDef="createdAt">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="createdAt">
          Created
        </th>
        <td mat-cell *matCellDef="let product">
          {{ product.createdAt | date : "short" }}
        </td>
      </ng-container>

      <!-- Updated At Column -->
      <ng-container matColumnDef="updatedAt">
        <th mat-header-cell *matHeaderCellDef>Updated</th>
        <td mat-cell *matCellDef="let product">
          {{ product.updatedAt | date : "short" }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let product">
          <button
            mat-button
            color="primary"
            (click)="goToEdit(product.id)"
            [disabled]="isDeleting(product.id)"
          >
            Edit
          </button>
          <button
            mat-button
            color="warn"
            (click)="deleteProduct(product.id, product.name)"
            [disabled]="isDeleting(product.id)"
          >
            {{ isDeleting(product.id) ? "Deleting..." : "Delete" }}
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <mat-paginator
      [length]="view.total"
      [pageIndex]="view.page"
      [pageSize]="view.pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </div>

  <!-- Mobile Card View -->
  <div class="mobile-view">
    @for (product of view.items; track product.id) {
    <div class="product-card">
      <div class="product-header">
        @if (product.imgUrl) {
        <img
          [src]="product.imgUrl"
          [alt]="product.name"
          class="product-image-mobile"
        />
        } @else {
        <div class="no-image-mobile">No image</div>
        }
        <div class="product-title">
          <h3>{{ product.name }}</h3>
          <span [class]="'status-' + product.status">{{
            product.status | titlecase
          }}</span>
        </div>
      </div>

      <div class="product-details">
        <div class="product-description">
          <strong>Description:</strong> {{ product.description || "N/A" }}
        </div>

        <div class="product-info-grid">
          <div class="info-item">
            <span class="label">ID:</span>
            <span class="value">{{ product.id }}</span>
          </div>
          <div class="info-item">
            <span class="label">Price:</span>
            <span class="value price"
              >${{ product.price | number : "1.2-2" }}</span
            >
          </div>
          <div class="info-item">
            <span class="label">Created:</span>
            <span class="value">{{ product.createdAt | date : "short" }}</span>
          </div>
          <div class="info-item">
            <span class="label">Updated:</span>
            <span class="value">{{ product.updatedAt | date : "short" }}</span>
          </div>
        </div>

        <div class="mobile-actions">
          <button
            mat-raised-button
            color="primary"
            (click)="goToEdit(product.id)"
            [disabled]="isDeleting(product.id)"
            class="edit-btn-mobile"
          >
            Edit
          </button>
          <button
            mat-raised-button
            color="warn"
            (click)="deleteProduct(product.id, product.name)"
            [disabled]="isDeleting(product.id)"
            class="delete-btn-mobile"
          >
            {{ isDeleting(product.id) ? "Deleting..." : "Delete" }}
          </button>
        </div>
      </div>
    </div>
    }
    <mat-paginator
      [length]="view.total"
      [pageIndex]="view.page"
      [pageSize]="view.pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </div>
  } } } }
</div>
